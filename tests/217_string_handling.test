#!/bin/sh

#
# Test environment variables embedded in strings in the config files
#
# If this fails, you're using an old version of libconfuse. This is sadly
# very common. See the readme, but the basic fix is to go to the libconfuse
# GitHub and build it yourself.
#

. "$(cd "$(dirname "$0")" && pwd)/common.sh"

export TEST_ENV_VAR=1K.bin

cat >$CONFIG <<EOF
# Escape sequence in double quotes
meta-product = "Octal \044 and hex \x3c"
# Backslashes are escaped
meta-description = "\\\\$"
# Escape sequences and variables dont get processed in single quotes
meta-version = '\044 \x3c \${}'
# Substitution happens in double quotes
meta-author = "Substitution \${}"
# Escapes quotes in double quotes (fwup weird behavior 1)
meta-platform = "\"\""
# Escapes quotes in single quotes (fwup weird behavior 2)
meta-architecture = '""'
EOF

cat >$EXPECTED_META_CONF <<EOF
meta-product="Octal $ and hex <"
meta-description="\\$"
meta-version="\044 \x3c \${}"
meta-author="Substitution"
meta-platform="\"\""
meta-architecture="\"\""
EOF

$FWUP_CREATE -c -f $CONFIG -o $FWFILE

# Check that the zip file was created as expected
check_meta_conf

# Check that the verify logic works on this file
$FWUP_VERIFY -V -i $FWFILE
